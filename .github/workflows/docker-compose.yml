name: Full Stack CI/CD

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]

env:
  DOCKER_COMPOSE_VERSION: '2.23.0'

jobs:
  # Integration Tests with Full Stack
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backend .env file
        run: |
          cat > backend/.env << EOF
          NODE_ENV=test
          PORT=5000
          MONGODB_URI=mongodb://admin:testpass@mongodb:27017/serene-test?authSource=admin
          REDIS_URL=redis://:testpass@redis:6379
          JWT_SECRET=test-jwt-secret-integration
          JWT_REFRESH_SECRET=test-refresh-secret-integration
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_TEST_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}
          EMAIL_HOST=smtp.gmail.com
          EMAIL_PORT=587
          EMAIL_USER=test@example.com
          EMAIL_PASSWORD=testpass
          FRONTEND_URL=http://localhost:3000
          EOF

      - name: Start services
        run: docker-compose -f docker-compose.dev.yml up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for MongoDB..."
          timeout 60 bash -c 'until docker-compose -f docker-compose.dev.yml exec -T mongodb mongosh --eval "db.runCommand({ping: 1})" > /dev/null 2>&1; do sleep 2; done'

          echo "Waiting for Redis..."
          timeout 60 bash -c 'until docker-compose -f docker-compose.dev.yml exec -T redis redis-cli ping > /dev/null 2>&1; do sleep 2; done'

          echo "Waiting for Backend..."
          timeout 120 bash -c 'until curl -f http://localhost:5000/api/v1/health > /dev/null 2>&1; do sleep 5; done'

          echo "All services are healthy!"

      - name: Run integration tests
        run: |
          docker-compose -f docker-compose.dev.yml exec -T backend npm run test:integration

      - name: Run E2E tests
        run: |
          docker-compose -f docker-compose.dev.yml exec -T frontend npm run test:e2e

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker-compose -f docker-compose.dev.yml logs backend
          echo "=== MongoDB Logs ==="
          docker-compose -f docker-compose.dev.yml logs mongodb
          echo "=== Redis Logs ==="
          docker-compose -f docker-compose.dev.yml logs redis

      - name: Cleanup
        if: always()
        run: docker-compose -f docker-compose.dev.yml down -v

  # Build and Push Full Stack Images
  build-stack:
    name: Build Full Stack
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push all images
        run: |
          # Set environment variables
          export DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          export VITE_API_URL=${{ secrets.VITE_API_URL }}

          # Build and push images
          docker-compose -f docker-compose.yml build
          docker-compose -f docker-compose.yml push

  # Deploy Full Stack
  deploy-production:
    name: Deploy Full Stack to Production
    runs-on: ubuntu-latest
    needs: [build-stack]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://serene-wellbeing.com

    steps:
      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/serene-wellbeing

            # Create production .env file
            cat > backend/.env << EOF
            NODE_ENV=production
            PORT=5000
            MONGODB_URI=${{ secrets.PROD_MONGODB_URI }}
            REDIS_URL=${{ secrets.PROD_REDIS_URL }}
            JWT_SECRET=${{ secrets.PROD_JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.PROD_JWT_REFRESH_SECRET }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.EMAIL_PORT }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            FRONTEND_URL=https://serene-wellbeing.com
            EOF

            # Pull and restart services
            docker-compose pull
            docker-compose up -d

            # Cleanup
            docker system prune -f

      - name: Health check - Backend
        run: |
          sleep 15
          curl -f https://api.serene-wellbeing.com/api/v1/health || exit 1

      - name: Health check - Frontend
        run: |
          curl -f https://serene-wellbeing.com || exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "Frontend: https://serene-wellbeing.com"
          echo "Backend: https://api.serene-wellbeing.com"

  deploy-staging:
    name: Deploy Full Stack to Staging
    runs-on: ubuntu-latest
    needs: [build-stack]
    if: github.ref == 'refs/heads/staging'
    environment:
      name: staging
      url: https://staging.serene-wellbeing.com

    steps:
      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/serene-wellbeing-staging

            # Create staging .env file
            cat > backend/.env << EOF
            NODE_ENV=staging
            PORT=5000
            MONGODB_URI=${{ secrets.STAGING_MONGODB_URI }}
            REDIS_URL=${{ secrets.STAGING_REDIS_URL }}
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.STAGING_JWT_REFRESH_SECRET }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_TEST_SECRET_KEY }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}
            EMAIL_HOST=${{ secrets.EMAIL_HOST }}
            EMAIL_PORT=${{ secrets.EMAIL_PORT }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
            FRONTEND_URL=https://staging.serene-wellbeing.com
            EOF

            # Pull and restart services
            docker-compose pull
            docker-compose up -d

            # Cleanup
            docker system prune -f

      - name: Health check - Backend
        run: |
          sleep 15
          curl -f https://staging-api.serene-wellbeing.com/api/v1/health || exit 1

      - name: Health check - Frontend
        run: |
          curl -f https://staging.serene-wellbeing.com || exit 1
